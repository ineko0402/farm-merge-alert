# FMV用アラーム管理

Farm Merge Valley（FMV）向けのエネルギー・物資・労働者タイマー管理ツール。ブラウザで動作し、PWA対応でオフラインでも利用可能。

## 主要機能

### アラーム機能
- **エネルギー回復アラーム**: 現在のエネルギー値から満タン(50)までの回復時間を計算し通知
- **物資アラーム**: 現在の物資数から36個到達までの時間を計算し通知
- **労働者アラーム**: プリセット時間(3分〜2時間)で複数のタイマーを同時管理

### 通知機能
- **2つの通知モード**
  - タイトル点滅モード（デフォルト）: ブラウザタブのタイトルが点滅
  - デスクトップ通知モード: OS標準の通知を表示（履歴に残る）
- **通知音**: 完了時に880Hzのビープ音を再生

### イベント対応
- **時間短縮イベントモード**: エネルギーと労働者の回復・作業時間を半減
  - 物資は時間短縮の対象外（常に通常時間）

### データ永続化
- LocalStorageによる状態保存
- ページをリロードしても設定とタイマーが復元

### PWA対応
- Service Workerによるオフライン動作
- ホーム画面に追加可能
- スタンドアロンモードで動作

## 使用方法

### エネルギーアラーム
1. 現在のエネルギー値（0〜49）を入力
2. 「開始する」をクリック
3. 満タン(50)到達時に通知

**回復時間**: 1エネルギーあたり3分
- 例: エネルギー0 → 50まで = 150分（2時間30分）
- イベント中: 75分（1時間15分）

### 物資アラーム
1. 現在の物資数（0〜39）を入力
2. 「開始する」をクリック
3. 36個到達時に通知

**回復時間**: 5分ごとに5個回復
- 例: 物資0 → 36個まで = 40分
- **注意**: 物資は時間短縮イベントの対象外

### 労働者アラーム
1. プリセットボタン（3分、5分、8分20秒、15分、30分、50分、1時間20分、2時間）をクリック
2. 複数のタイマーを同時に設定可能
3. 各タイマーは個別に管理
   - `+`ボタン: 1分延長
   - `-`ボタン: 1分短縮
   - 削除ボタン: タイマー削除

**イベント中**: 設定時間が半減

### 通知モード切り替え
1. ヘッダーの「通知モード」ボタンをクリック
2. デスクトップ通知を選択した場合、ブラウザの通知許可が必要

## 動作環境

- **ブラウザ**: Chrome、Edge、Safari、Firefox（最新版推奨）
- **必須機能**:
  - LocalStorage
  - Web Audio API（通知音用）
  - Notification API（デスクトップ通知用、オプション）
  - Service Worker（PWA機能用、オプション）

## インストール・実行方法

### 通常利用
1. ブラウザで `index.html` を開く
2. PWAとしてインストールする場合:
   - Chrome/Edge: アドレスバーの「インストール」アイコンをクリック
   - Safari: 共有メニュー → ホーム画面に追加

### 開発環境
```bash
# ローカルサーバーで起動（推奨）
# Python 3の場合
python -m http.server 8000

# Node.jsの場合
npx http-server

# ブラウザで http://localhost:8000 を開く
```

**開発モード**: `localhost`、`github.io`、`file://`プロトコルで開くと自動的に開発モードになり、キャッシュが無効化されます。

## ファイル構成

```
farm-merge-alert/
├── index.html          # メインHTML
├── script.js           # アプリケーションロジック
├── style.css           # スタイルシート
├── manifest.json       # PWAマニフェスト
├── sw.js              # Service Worker
├── icon-192.png       # アプリアイコン (192x192)
├── icon-512.png       # アプリアイコン (512x512)
└── favicon_32x32.png  # ファビコン
```

### 主要ファイル詳細

**script.js**
- エネルギー回復計算: 1エネルギー = 3分
- 物資回復計算: 5分ごとに5個（イベント対象外）
- 労働者タイマー管理
- 通知システム（タイトル点滅/デスクトップ通知）
- LocalStorageによる状態管理
- `setInterval`による1秒ごとの更新（バックグラウンドでも正確に動作）

**style.css**
- レスポンシブデザイン
- ダークテーマ
- アニメーション効果（完了時の緑色表示、削除時のフェードアウト）

**sw.js**
- キャッシュバージョン: `v20251205`
- オフライン対応

## 制限事項・既知の問題

### 機能制限
- **通知の重複防止**: 各アラームは完了後、一度だけ通知を発火（`fired`フラグで管理）
- **バックグラウンド動作**: `setInterval`を使用しているため、ブラウザがバックグラウンドでも1秒ごとに正確に動作
- **物資の目標値固定**: 物資アラームは36個固定（変更不可）
- **エネルギー上限**: 50固定（変更不可）

### ブラウザ依存
- **デスクトップ通知**: ブラウザの通知許可が必要
- **通知音**: 一部のブラウザでユーザー操作なしでは再生されない場合がある
- **PWA**: iOS Safariでは一部機能に制限あり

### 既知の問題
- 開発モードでService Workerが自動削除されるため、本番環境では通常モードで使用すること
- タイトル点滅中にタブを切り替えると点滅が見えなくなる（仕様）

## 技術仕様

### 使用技術
- **フロントエンド**: Vanilla JavaScript (ES6+)
- **スタイル**: CSS3
- **ストレージ**: LocalStorage
- **通知**: Notification API, Web Audio API
- **PWA**: Service Worker, Web App Manifest

### 主要ライブラリ
- 外部ライブラリ不使用（Pure JavaScript）

### 計算ロジック
```javascript
// エネルギー回復時間
duration = (50 - currentEnergy) * 3 * 60 * 1000 * (isEvent ? 0.5 : 1)

// 物資回復時間（イベント対象外）
duration = Math.ceil((36 - currentSupply) / 5) * 5 * 60 * 1000

// 労働者タイマー
duration = minutes * 60 * 1000 * (isEvent ? 0.5 : 1)
```

### 状態管理
```javascript
{
  energy: {targetAt, duration, fired},
  supply: {targetAt, targetCount, currentCount, duration, fired},
  workers: [{id, targetAt, fired, minutes, label}],
  halfEvent: boolean
}
```

## ライセンス

このプロジェクトのライセンス情報は記載されていません。
